---
// @ts-nocheck
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import ListItems from '../../components/ListItems.astro';
import Pagination from '../../components/Pagination.astro';

export async function getStaticPaths({ paginate }) {
  const allPosts = await getCollection('posts');

  // Sort by date descending
  const sortedPosts = allPosts.sort((a, b) =>
    b.data.date.valueOf() - a.data.date.valueOf()
  );

  // Requirement: Paginate into groups of 11
  return paginate(sortedPosts, { pageSize: 11 });
}

// All paginated data is passed via the "page" prop
const { page } = Astro.props;

const seo = {
  title: `Article archive - page ${page.currentPage}`,
  description: `Article archive page ${page.currentPage} from ajfisher.me`,
  type: 'list',
};

const mergeEntryData = (entry) => {
  const frontmatter = entry?.rendered?.metadata?.frontmatter ?? {};

  return {
    ...entry.data,
    ...frontmatter,
    featureimage: entry.data.featureimage ?? frontmatter.featureimage,
    listimage: entry.data.listimage ?? frontmatter.listimage,
  };
};

// The logic here is this:
// 1. Find the most recent featured post of the posts supplied unless we are
// on page 1 of the archive in which case we want to get the second most recent
// featured post.
// 2. Pull that one out of the main list and make it `featured`
// 3. Set the header zone and links to represent that featured post
// 4. Render the other 10 posts as normal in the list.

let featuredPost = null;
const featuredPosts = page.data.filter(post => post.data.featured);
if (page.currentPage === 1) {
  // Get the second most recent featured post for first page of archive
  if (featuredPosts.length > 1) {
    featuredPost = featuredPosts[1];
  } else if (featuredPosts.length === 1) {
    featuredPost = featuredPosts[0];
  }
} else {
  // Get the most recent featured post
  if (featuredPosts.length > 0) {
    featuredPost = featuredPosts[0];
  }
}

let posts = page.data;

// if not featured post then make featured post the first post in the list
// then we remove the featured post from the post list
// then we handle rendering out.

if (!featuredPost && page.data.length > 0) {
  featuredPost = page.data[0];
}

if (featuredPost) {
  // Remove the featured post from the main list
  posts = page.data.filter(post => post !== featuredPost);
}
---

<BaseLayout title={`Blog Archive - Page ${page.currentPage}`} seo={seo}>
  <Fragment slot="header">
    <Header { ...mergeEntryData(featuredPost) }
      isFeatured={true}
    />
  </Fragment>
  <section itemtype="https://schema.org/Blog" class="list">
    <h1>Article archive - page {page.currentPage}</h1>
    <ListItems items={posts} />
    <Pagination { ...{ page } } />
  </section>
</BaseLayout>

<style>
</style>
