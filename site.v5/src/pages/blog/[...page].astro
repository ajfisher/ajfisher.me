---
// @ts-nocheck
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import ListItems from '../../components/ListItems.astro';

import { imageTransform } from '../../lib/utils.mjs';

export async function getStaticPaths({ paginate }) {
  const allPosts = await getCollection('posts');

  // Sort by date descending
  const sortedPosts = allPosts.sort((a, b) =>
    b.data.date.valueOf() - a.data.date.valueOf()
  );

  // Requirement: Paginate into groups of 11
  return paginate(sortedPosts, { pageSize: 11 });
}

// All paginated data is passed via the "page" prop
const { page } = Astro.props;

// The logic here is this:
// 1. Find the most recent featured post of the posts supplied unless we are
// on page 1 of the archive in which case we want to get the second most recent
// featured post.
// 2. Pull that one out of the main list and make it `featured`
// 3. Set the header zone and links to represent that featured post
// 4. Render the other 10 posts as normal in the list.

let featuredPost = null;
const featuredPosts = page.data.filter(post => post.data.featured);
if (page.currentPage === 1) {
  // Get the second most recent featured post for first page of archive
  if (featuredPosts.length > 1) {
    featuredPost = featuredPosts[1];
  } else if (featuredPosts.length === 1) {
    featuredPost = featuredPosts[0];
  }
} else {
  // Get the most recent featured post
  if (featuredPosts.length > 0) {
    featuredPost = featuredPosts[0];
  }
}

let posts = page.data;

// if not featured post then make featured post the first post in the list
// then we remove the featured post from the post list
// then we handle rendering out.

if (!featuredPost && page.data.length > 0) {
  featuredPost = page.data[0];
}

if (featuredPost) {
  // Remove the featured post from the main list
  posts = page.data.filter(post => post !== featuredPost);
}
---

<BaseLayout title={`Blog Archive - Page ${page.currentPage}`}>
  <Fragment slot="header">
    <Header { ...{...featuredPost.data, ...featuredPost.rendered.metadata.frontmatter} }
      isFeatured={true}
    />
  </Fragment>
  <section itemtype="https://schema.org/Blog" class="list">
    <h1>Article archive - page {page.currentPage}</h1>
    <ListItems items={posts} />
  </section>
  <nav class="pagination">
    {page.url.prev ? <a href={page.url.prev}>&larr; Newer</a> : null}

    <span>Page {page.currentPage} of {page.lastPage}</span>

    {page.url.next ? <a href={page.url.next}>Older &rarr;</a> : null}
  </nav>
</BaseLayout>

<style>
  .pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #eee;
  }
</style>
