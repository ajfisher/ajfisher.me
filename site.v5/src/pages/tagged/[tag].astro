---
// @ts-nocheck
import { getCollection } from 'astro:content';

import tagMetadata from '../../../../content/lib/tag_data.json';

import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';

import { imageTransform } from '../../lib/utils.mjs';

export async function getStaticPaths() {
  const posts = (await getCollection('posts')).sort(
    (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
  );
  // Get unique tags by their SLUG to avoid duplicates
  const tagMap = new Map();
  posts.forEach(post => {
    post.data.tags.forEach(t => {
      tagMap.set(t.slug, t.name);
    });
  });

  return Array.from(tagMap.entries()).map(([slug, name]) => {
    const tagPosts = posts.filter(post =>
      post.data.tags.some(t => t.slug === slug)
    );

    const metadata = tagMetadata.find(item => item.tag.toLowerCase() === name.toLowerCase()) || {
      tag: name,
      title: name,
      intro: `Archives for the ${name} category.`,
      uri: slug,
    };

    return {
      params: { tag: slug },
      props: { tagName: name, posts: tagPosts, metadata },
    };
  });
}

const { tagName, posts, metadata } = Astro.props;

const headerData = {
  title: metadata.title || tagName,
  excerpt: metadata.intro,
  featureimage: imageTransform(metadata.tagimage),
  postCount: posts.length
}

console.log('tag page', Astro.props.metadata);
---
<BaseLayout title={metadata.title}>
  <Fragment slot="header" { ...headerData }>
    <Header { ...headerData } largetitle={true} />
  </Fragment>

  <ul>
    {posts.map(post => (
      <li><a href={`/${post.data.uri}`}>{post.data.title}</a></li>
    ))}
  </ul>
</BaseLayout>
